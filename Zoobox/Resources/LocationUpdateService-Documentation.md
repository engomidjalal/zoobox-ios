# üìç LocationUpdateService Documentation

## Overview

The `LocationUpdateService` is a comprehensive location tracking system that automatically posts user location updates to the API (`https://mikmik.site/Location_updater.php`) in various scenarios while respecting user permissions and privacy.

## ‚ú® Features

### üîÑ **Automatic Triggers**
- **App Lifecycle Events**: Start, close, background, device lock
- **Timer-Based**: Every 10 minutes (configurable)
- **WebView Refresh**: On every page load/refresh
- **Manual Triggers**: Programmatic location updates

### üîí **Security & Privacy**
- ‚úÖ Only operates when location permission is granted
- ‚úÖ Only posts when `user_id` cookie exists
- ‚úÖ Validates location accuracy (< 50 meters)
- ‚úÖ Lazy initialization to prevent premature permission requests

### üìä **Monitoring & Debug**
- Real-time status tracking
- Update counter
- Comprehensive logging
- Debug information available

## üèóÔ∏è Architecture

### Core Components

```swift
@MainActor
class LocationUpdateService: NSObject, ObservableObject {
    static let shared = LocationUpdateService()  // Singleton
    
    // Location Management
    private var locationManager: CLLocationManager?  // Lazy initialization
    private var currentLocation: CLLocation?         // Cached location
    
    // Timer Management  
    private var updateTimer: Timer?                  // 10-minute timer
    private var lastPostTime: Date?                 // Last update timestamp
    
    // Monitoring
    @Published var lastUpdateStatus: String         // Real-time status
    @Published var totalUpdatesSent: Int           // Update counter
}
```

## üéØ Trigger Scenarios

### 1. **App Lifecycle Events**

| Event | Trigger | Description |
|-------|---------|-------------|
| App Start | `app_became_active` | User opens app |
| App Close | `app_will_terminate` | User closes app |
| Background | `app_entered_background` | App goes to background |
| Foreground | `app_will_resign_active` | App becomes inactive |
| Device Lock | `device_locked` | Screen locks |

### 2. **Timer-Based Updates**
```swift
private let updateInterval: TimeInterval = 600 // 10 minutes
```

### 3. **WebView Refresh**
```swift
// Triggered on every page load
LocationUpdateService.shared.onWebViewRefresh()
```

### 4. **Manual Triggers**
```swift
// Programmatic location update
LocationUpdateService.shared.manualLocationUpdate()
```

## üîß Implementation Details

### Lazy Initialization Pattern

The service uses lazy initialization to prevent triggering location permission dialogs during app startup:

```swift
private func ensureLocationManagerInitialized() {
    if locationManager == nil {
        setupLocationManager()
    }
}

private func setupLocationManager() {
    if locationManager == nil {
        locationManager = CLLocationManager()
    }
    locationManager?.delegate = self
    locationManager?.desiredAccuracy = kCLLocationAccuracyBest
    locationManager?.distanceFilter = 10.0
}
```

### Permission Checking

```swift
private func isLocationPermissionGranted() -> Bool {
    let authStatus = CLLocationManager.authorizationStatus()
    return authStatus == .authorizedWhenInUse || authStatus == .authorizedAlways
}
```

### Cookie Validation

```swift
private func extractUserIdFromCookies() async -> String? {
    do {
        let cookies = try await websiteDataStore.httpCookieStore.allCookies()
        let userIdCookie = cookies.first { cookie in
            cookie.domain.contains("mikmik.site") && cookie.name == "user_id"
        }
        return userIdCookie?.value
    } catch {
        return nil
    }
}
```

### Location Accuracy Validation

```swift
// API requirement: accuracy must be < 50 meters
guard location.horizontalAccuracy < 50.0 else {
    print("üìç Location accuracy too poor: \(location.horizontalAccuracy)m")
    return
}
```

## üöÄ API Integration

### Endpoint Configuration
```swift
private let apiURL = "https://mikmik.site/Location_updater.php"
```

### Request Format
```json
{
    "user_id": "string",
    "latitude": double,
    "longitude": double,
    "accuracy": double
}
```

### Response Handling
```swift
if let success = jsonResponse["success"] as? Bool {
    if success {
        totalUpdatesSent += 1
        lastUpdateStatus = "‚úÖ Success (\(trigger))"
    } else {
        let message = jsonResponse["message"] as? String ?? "Unknown error"
        lastUpdateStatus = "‚ùå API Error: \(message)"
    }
}
```

## üì± Integration Guide

### 1. **AppDelegate Integration**

```swift
// AppDelegate.swift
private func setupLocationUpdateService() {
    let locationService = LocationUpdateService.shared
    print("üìç AppDelegate: Location update service initialized")
    
    // Don't start location services here - let onboarding handle permissions
    print("üìç AppDelegate: Location services will start after proper permission flow")
}
```

### 2. **MainViewController Integration**

```swift
// MainViewController.swift
private func setupLocationUpdateService() {
    let locationService = LocationUpdateService.shared
    
    // Only start if permission already granted
    let authStatus = CLLocationManager.authorizationStatus()
    if authStatus == .authorizedWhenInUse || authStatus == .authorizedAlways {
        locationService.startLocationServices()
    }
}

// WebView refresh trigger
func webView(_ webView: WKWebView, didFinish navigation: WKNavigation!) {
    // ... existing code ...
    LocationUpdateService.shared.onWebViewRefresh()
}
```

## üêõ Debug & Monitoring

### Real-time Status Monitoring

```swift
// Access current status
let service = LocationUpdateService.shared
print("Status: \(service.lastUpdateStatus)")
print("Total Updates: \(service.totalUpdatesSent)")
```

### Debug Information

```swift
let debugInfo = await LocationUpdateService.shared.getDebugInfo()
print("Debug Info: \(debugInfo)")

// Output example:
[
    "location_permission": 3,
    "location_services_enabled": true,
    "user_id": "abc123...",
    "current_location": 37.7749,
    "last_update_status": "‚úÖ Success (webview_refresh)",
    "total_updates_sent": 42,
    "last_post_time": "2024-12-XX XX:XX:XX",
    "update_interval": 600.0,
    "api_url": "https://mikmik.site/Location_updater.php"
]
```

### Console Logging

The service provides detailed logging with `üìç` prefix:

```
üìç [LocationUpdateService] =================================
üìç [LocationUpdateService] Location update triggered by: webview_refresh
üìç [LocationUpdateService] =================================
üìç [LocationUpdateService] Found user_id cookie: abc123...
üìç [LocationUpdateService] üöÄ POSTING LOCATION TO API
üìç [LocationUpdateService] user_id: abc123...
üìç [LocationUpdateService] latitude: 37.7749
üìç [LocationUpdateService] longitude: -122.4194
üìç [LocationUpdateService] accuracy: 15.0
üìç [LocationUpdateService] trigger: webview_refresh
üìç [LocationUpdateService] Response status: 200
üìç [LocationUpdateService] ‚úÖ Location update successful
üìç [LocationUpdateService] ‚úÖ Location update completed for trigger: webview_refresh
```

## ‚öôÔ∏è Configuration

### Timer Interval
```swift
private let updateInterval: TimeInterval = 600 // 10 minutes

// To modify, change the value and restart the service
```

### Location Accuracy
```swift
locationManager?.desiredAccuracy = kCLLocationAccuracyBest
locationManager?.distanceFilter = 10.0 // Update every 10 meters
```

### API Accuracy Requirement
```swift
// Must be < 50 meters as per API specification
guard location.horizontalAccuracy < 50.0 else { return }
```

## üîÑ Flow Diagram

```mermaid
graph TD
    A[App Launch] --> B[Service Initialize]
    B --> C[Setup Observers & Timer]
    C --> D[Wait for Triggers]
    
    D --> E[Trigger Event]
    E --> F{Location Permission?}
    F -->|No| G[Skip Update]
    F -->|Yes| H{user_id Cookie Exists?}
    H -->|No| I[Skip Update]
    H -->|Yes| J[Get Current Location]
    
    J --> K{Accuracy < 50m?}
    K -->|No| L[Skip Update - Poor Accuracy]
    K -->|Yes| M[POST to API]
    
    M --> N{API Success?}
    N -->|Yes| O[Update Counter & Status]
    N -->|No| P[Log Error]
    
    O --> D
    P --> D
    G --> D
    I --> D
    L --> D
```

## üß™ Testing Scenarios

### Test Cases

1. **Fresh Install**
   - ‚úÖ No permission dialog on app launch
   - ‚úÖ Service initializes without location manager
   - ‚úÖ Location manager created only when needed

2. **Permission Granted**
   - ‚úÖ Location services start automatically
   - ‚úÖ Updates post successfully to API
   - ‚úÖ All triggers work correctly

3. **Permission Denied**
   - ‚úÖ No location requests made
   - ‚úÖ Service skips updates gracefully
   - ‚úÖ No crashes or errors

4. **No user_id Cookie**
   - ‚úÖ Service skips API posts
   - ‚úÖ Logs appropriate message
   - ‚úÖ Continues monitoring for cookie

5. **Poor Location Accuracy**
   - ‚úÖ Updates skipped when accuracy >= 50m
   - ‚úÖ Service waits for better accuracy
   - ‚úÖ Logs accuracy information

### Manual Testing Commands

```swift
// Test manual trigger
LocationUpdateService.shared.manualLocationUpdate()

// Check current status
print(LocationUpdateService.shared.lastUpdateStatus)

// Get debug information
Task {
    let debug = await LocationUpdateService.shared.getDebugInfo()
    print("Debug: \(debug)")
}
```

## üö® Troubleshooting

### Common Issues

| Issue | Cause | Solution |
|-------|-------|----------|
| No updates sent | Missing user_id cookie | Wait for user login |
| Permission dialog on launch | Early CLLocationManager init | Check lazy initialization |
| Poor accuracy rejections | GPS signal issues | Wait for better signal |
| API errors | Network/server issues | Check API endpoint |

### Status Messages

| Status | Meaning |
|--------|---------|
| `"Not started"` | Service not yet triggered |
| `"Location permission denied"` | No location access |
| `"user_id cookie not found"` | User not logged in |
| `"Failed to get location"` | GPS/location error |
| `"Location accuracy too poor"` | Accuracy >= 50 meters |
| `"‚úÖ Success (trigger)"` | Update posted successfully |
| `"‚ùå API Error: message"` | Server error |
| `"Network error: description"` | Connection issue |

## üìù Best Practices

### 1. **Permission Handling**
- Always check permission before requesting location
- Let onboarding flow handle initial permission requests
- Gracefully handle permission denial

### 2. **Performance**
- Use cached location when recent (< 5 minutes)
- Background thread for network requests
- Timeout location requests (10 seconds)

### 3. **Error Handling**
- Log all errors for debugging
- Fail gracefully without crashing
- Provide meaningful status messages

### 4. **Privacy**
- Only operate with explicit permissions
- Respect user cookie preferences
- Validate location accuracy

## üîÆ Future Enhancements

### Potential Improvements

1. **Background Location**
   - Add background location capability
   - Implement significant location changes
   - Background app refresh support

2. **Enhanced Accuracy**
   - Multiple location samples
   - Kalman filtering
   - Motion detection

3. **Offline Support**
   - Queue updates when offline
   - Retry failed requests
   - Local storage backup

4. **Analytics**
   - Update success rates
   - Performance metrics
   - Usage statistics

5. **Configuration**
   - Dynamic update intervals
   - Accuracy thresholds
   - Custom API endpoints

---

## üìÑ Version History

| Version | Date | Changes |
|---------|------|---------|
| 1.0 | 2024-12 | Initial implementation |
| 1.1 | 2024-12 | Fixed permission timing issue |
| 1.2 | 2024-12 | Added comprehensive documentation |

---

*For additional support or questions, contact the development team.* 